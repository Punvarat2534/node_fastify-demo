var ns=Object.defineProperty;var De=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+t+'" is not supported')});var ss=(t,e)=>{for(var r in e)ns(t,r,{get:e[r],enumerable:!0})};var Ze={};ss(Ze,{astGrepNodeContext:()=>be,cwdContext:()=>G,describeContext:()=>tn,fileContext:()=>pt,getAstGrepNodeContext:()=>L,getContextsSnapshot:()=>If,getCwdContext:()=>v,getDescribeContext:()=>kf,getFileContext:()=>b,getGitContext:()=>zt,getParentContext:()=>Ef,getParentCwdContext:()=>Qe,getRepositoriesContext:()=>Of,getRepositoryContext:()=>Xe,gitContext:()=>we,migrateContext:()=>Lf,parentContextLegacy:()=>Zo,parentCwdContext:()=>_e,registerContext:()=>Q,repositoriesContext:()=>en,repositoryContext:()=>X});import{AsyncLocalStorage as V}from"node:async_hooks";import{invariant as Bt}from"ts-invariant";import{simpleGit as is}from"simple-git";var yt=class{_context;constructor(e){this._context=e}set(e,r){this._context[e]=r}get(e){return this._context[e]}};var wt=class extends yt{get simpleGit(){return is(v().cwd)}async checkout({branch:e,force:r}){try{await this.simpleGit.checkout(e)}catch(o){if(r)await this.simpleGit.checkout(["-b",e]);else throw o}}};import ye from"colors-cli";var as=typeof global=="object"&&global&&global.Object===Object&&global,Jt=as;var ps=typeof self=="object"&&self&&self.Object===Object&&self,fs=Jt||ps||Function("return this")(),F=fs;var ls=F.Symbol,I=ls;var pr=Object.prototype,us=pr.hasOwnProperty,cs=pr.toString,Gt=I?I.toStringTag:void 0;function ms(t){var e=us.call(t,Gt),r=t[Gt];try{t[Gt]=void 0;var o=!0}catch{}var n=cs.call(t);return o&&(e?t[Gt]=r:delete t[Gt]),n}var fr=ms;var ds=Object.prototype,gs=ds.toString;function hs(t){return gs.call(t)}var lr=hs;var xs="[object Null]",ys="[object Undefined]",ur=I?I.toStringTag:void 0;function ws(t){return t==null?t===void 0?ys:xs:ur&&ur in Object(t)?fr(t):lr(t)}var M=ws;function bs(t){return t!=null&&typeof t=="object"}var B=bs;var _s="[object Symbol]";function As(t){return typeof t=="symbol"||B(t)&&M(t)==_s}var bt=As;function Cs(t,e){for(var r=-1,o=t==null?0:t.length,n=Array(o);++r<o;)n[r]=e(t[r],r,t);return n}var Yt=Cs;var Ps=Array.isArray,S=Ps;var vs=1/0,cr=I?I.prototype:void 0,mr=cr?cr.toString:void 0;function dr(t){if(typeof t=="string")return t;if(S(t))return Yt(t,dr)+"";if(bt(t))return mr?mr.call(t):"";var e=t+"";return e=="0"&&1/t==-vs?"-0":e}var gr=dr;function Rs(t){var e=typeof t;return t!=null&&(e=="object"||e=="function")}var z=Rs;function Ss(t){return t}var _t=Ss;var Ts="[object AsyncFunction]",Fs="[object Function]",Hs="[object GeneratorFunction]",Es="[object Proxy]";function Ls(t){if(!z(t))return!1;var e=M(t);return e==Fs||e==Hs||e==Ts||e==Es}var Vt=Ls;var Is=F["__core-js_shared__"],Qt=Is;var hr=function(){var t=/[^.]+$/.exec(Qt&&Qt.keys&&Qt.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}();function Os(t){return!!hr&&hr in t}var xr=Os;var ks=Function.prototype,js=ks.toString;function Ds(t){if(t!=null){try{return js.call(t)}catch{}try{return t+""}catch{}}return""}var tt=Ds;var Gs=/[\\^$.*+?()[\]{}|]/g,Ns=/^\[object .+?Constructor\]$/,$s=Function.prototype,Ms=Object.prototype,Bs=$s.toString,zs=Ms.hasOwnProperty,Ws=RegExp("^"+Bs.call(zs).replace(Gs,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Ks(t){if(!z(t)||xr(t))return!1;var e=Vt(t)?Ws:Ns;return e.test(tt(t))}var yr=Ks;function Us(t,e){return t?.[e]}var wr=Us;function qs(t,e){var r=wr(t,e);return yr(r)?r:void 0}var O=qs;var Js=O(F,"WeakMap"),Xt=Js;function Ys(){}var Ge=Ys;var Vs=function(){try{var t=O(Object,"defineProperty");return t({},"",{}),t}catch{}}(),Ne=Vs;var Qs=9007199254740991,Xs=/^(?:0|[1-9]\d*)$/;function Zs(t,e){var r=typeof t;return e=e??Qs,!!e&&(r=="number"||r!="symbol"&&Xs.test(t))&&t>-1&&t%1==0&&t<e}var At=Zs;function ti(t,e,r){e=="__proto__"&&Ne?Ne(t,e,{configurable:!0,enumerable:!0,value:r,writable:!0}):t[e]=r}var Zt=ti;function ei(t,e){return t===e||t!==t&&e!==e}var Ct=ei;var ri=Object.prototype,oi=ri.hasOwnProperty;function ni(t,e,r){var o=t[e];(!(oi.call(t,e)&&Ct(o,r))||r===void 0&&!(e in t))&&Zt(t,e,r)}var br=ni;var si=9007199254740991;function ii(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=si}var Pt=ii;function ai(t){return t!=null&&Pt(t.length)&&!Vt(t)}var te=ai;var pi=Object.prototype;function fi(t){var e=t&&t.constructor,r=typeof e=="function"&&e.prototype||pi;return t===r}var ee=fi;function li(t,e){for(var r=-1,o=Array(t);++r<t;)o[r]=e(r);return o}var _r=li;var ui="[object Arguments]";function ci(t){return B(t)&&M(t)==ui}var $e=ci;var Ar=Object.prototype,mi=Ar.hasOwnProperty,di=Ar.propertyIsEnumerable,gi=$e(function(){return arguments}())?$e:function(t){return B(t)&&mi.call(t,"callee")&&!di.call(t,"callee")},vt=gi;function hi(){return!1}var Cr=hi;var Rr=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Pr=Rr&&typeof module=="object"&&module&&!module.nodeType&&module,xi=Pr&&Pr.exports===Rr,vr=xi?F.Buffer:void 0,yi=vr?vr.isBuffer:void 0,wi=yi||Cr,Nt=wi;var bi="[object Arguments]",_i="[object Array]",Ai="[object Boolean]",Ci="[object Date]",Pi="[object Error]",vi="[object Function]",Ri="[object Map]",Si="[object Number]",Ti="[object Object]",Fi="[object RegExp]",Hi="[object Set]",Ei="[object String]",Li="[object WeakMap]",Ii="[object ArrayBuffer]",Oi="[object DataView]",ki="[object Float32Array]",ji="[object Float64Array]",Di="[object Int8Array]",Gi="[object Int16Array]",Ni="[object Int32Array]",$i="[object Uint8Array]",Mi="[object Uint8ClampedArray]",Bi="[object Uint16Array]",zi="[object Uint32Array]",_={};_[ki]=_[ji]=_[Di]=_[Gi]=_[Ni]=_[$i]=_[Mi]=_[Bi]=_[zi]=!0;_[bi]=_[_i]=_[Ii]=_[Ai]=_[Oi]=_[Ci]=_[Pi]=_[vi]=_[Ri]=_[Si]=_[Ti]=_[Fi]=_[Hi]=_[Ei]=_[Li]=!1;function Wi(t){return B(t)&&Pt(t.length)&&!!_[M(t)]}var Sr=Wi;function Ki(t){return function(e){return t(e)}}var Tr=Ki;var Fr=typeof exports=="object"&&exports&&!exports.nodeType&&exports,$t=Fr&&typeof module=="object"&&module&&!module.nodeType&&module,Ui=$t&&$t.exports===Fr,Me=Ui&&Jt.process,qi=function(){try{var t=$t&&$t.require&&$t.require("util").types;return t||Me&&Me.binding&&Me.binding("util")}catch{}}(),Be=qi;var Hr=Be&&Be.isTypedArray,Ji=Hr?Tr(Hr):Sr,re=Ji;var Yi=Object.prototype,Vi=Yi.hasOwnProperty;function Qi(t,e){var r=S(t),o=!r&&vt(t),n=!r&&!o&&Nt(t),s=!r&&!o&&!n&&re(t),i=r||o||n||s,a=i?_r(t.length,String):[],p=a.length;for(var f in t)(e||Vi.call(t,f))&&!(i&&(f=="length"||n&&(f=="offset"||f=="parent")||s&&(f=="buffer"||f=="byteLength"||f=="byteOffset")||At(f,p)))&&a.push(f);return a}var oe=Qi;function Xi(t,e){return function(r){return t(e(r))}}var ne=Xi;var Zi=ne(Object.keys,Object),Er=Zi;var ta=Object.prototype,ea=ta.hasOwnProperty;function ra(t){if(!ee(t))return Er(t);var e=[];for(var r in Object(t))ea.call(t,r)&&r!="constructor"&&e.push(r);return e}var Lr=ra;function oa(t){return te(t)?oe(t):Lr(t)}var Rt=oa;function na(t){var e=[];if(t!=null)for(var r in Object(t))e.push(r);return e}var Ir=na;var sa=Object.prototype,ia=sa.hasOwnProperty;function aa(t){if(!z(t))return Ir(t);var e=ee(t),r=[];for(var o in t)o=="constructor"&&(e||!ia.call(t,o))||r.push(o);return r}var Or=aa;function pa(t){return te(t)?oe(t,!0):Or(t)}var kr=pa;var fa=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,la=/^\w*$/;function ua(t,e){if(S(t))return!1;var r=typeof t;return r=="number"||r=="symbol"||r=="boolean"||t==null||bt(t)?!0:la.test(t)||!fa.test(t)||e!=null&&t in Object(e)}var St=ua;var ca=O(Object,"create"),et=ca;function ma(){this.__data__=et?et(null):{},this.size=0}var jr=ma;function da(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e}var Dr=da;var ga="__lodash_hash_undefined__",ha=Object.prototype,xa=ha.hasOwnProperty;function ya(t){var e=this.__data__;if(et){var r=e[t];return r===ga?void 0:r}return xa.call(e,t)?e[t]:void 0}var Gr=ya;var wa=Object.prototype,ba=wa.hasOwnProperty;function _a(t){var e=this.__data__;return et?e[t]!==void 0:ba.call(e,t)}var Nr=_a;var Aa="__lodash_hash_undefined__";function Ca(t,e){var r=this.__data__;return this.size+=this.has(t)?0:1,r[t]=et&&e===void 0?Aa:e,this}var $r=Ca;function Tt(t){var e=-1,r=t==null?0:t.length;for(this.clear();++e<r;){var o=t[e];this.set(o[0],o[1])}}Tt.prototype.clear=jr;Tt.prototype.delete=Dr;Tt.prototype.get=Gr;Tt.prototype.has=Nr;Tt.prototype.set=$r;var ze=Tt;function Pa(){this.__data__=[],this.size=0}var Mr=Pa;function va(t,e){for(var r=t.length;r--;)if(Ct(t[r][0],e))return r;return-1}var ot=va;var Ra=Array.prototype,Sa=Ra.splice;function Ta(t){var e=this.__data__,r=ot(e,t);if(r<0)return!1;var o=e.length-1;return r==o?e.pop():Sa.call(e,r,1),--this.size,!0}var Br=Ta;function Fa(t){var e=this.__data__,r=ot(e,t);return r<0?void 0:e[r][1]}var zr=Fa;function Ha(t){return ot(this.__data__,t)>-1}var Wr=Ha;function Ea(t,e){var r=this.__data__,o=ot(r,t);return o<0?(++this.size,r.push([t,e])):r[o][1]=e,this}var Kr=Ea;function Ft(t){var e=-1,r=t==null?0:t.length;for(this.clear();++e<r;){var o=t[e];this.set(o[0],o[1])}}Ft.prototype.clear=Mr;Ft.prototype.delete=Br;Ft.prototype.get=zr;Ft.prototype.has=Wr;Ft.prototype.set=Kr;var nt=Ft;var La=O(F,"Map"),st=La;function Ia(){this.size=0,this.__data__={hash:new ze,map:new(st||nt),string:new ze}}var Ur=Ia;function Oa(t){var e=typeof t;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?t!=="__proto__":t===null}var qr=Oa;function ka(t,e){var r=t.__data__;return qr(e)?r[typeof e=="string"?"string":"hash"]:r.map}var it=ka;function ja(t){var e=it(this,t).delete(t);return this.size-=e?1:0,e}var Jr=ja;function Da(t){return it(this,t).get(t)}var Yr=Da;function Ga(t){return it(this,t).has(t)}var Vr=Ga;function Na(t,e){var r=it(this,t),o=r.size;return r.set(t,e),this.size+=r.size==o?0:1,this}var Qr=Na;function Ht(t){var e=-1,r=t==null?0:t.length;for(this.clear();++e<r;){var o=t[e];this.set(o[0],o[1])}}Ht.prototype.clear=Ur;Ht.prototype.delete=Jr;Ht.prototype.get=Yr;Ht.prototype.has=Vr;Ht.prototype.set=Qr;var mt=Ht;var $a="Expected a function";function We(t,e){if(typeof t!="function"||e!=null&&typeof e!="function")throw new TypeError($a);var r=function(){var o=arguments,n=e?e.apply(this,o):o[0],s=r.cache;if(s.has(n))return s.get(n);var i=t.apply(this,o);return r.cache=s.set(n,i)||s,i};return r.cache=new(We.Cache||mt),r}We.Cache=mt;var D=We;var Ma=500;function Ba(t){var e=D(t,function(o){return r.size===Ma&&r.clear(),o}),r=e.cache;return e}var Xr=Ba;var za=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Wa=/\\(\\)?/g,Ka=Xr(function(t){var e=[];return t.charCodeAt(0)===46&&e.push(""),t.replace(za,function(r,o,n,s){e.push(n?s.replace(Wa,"$1"):o||r)}),e}),Zr=Ka;function Ua(t){return t==null?"":gr(t)}var to=Ua;function qa(t,e){return S(t)?t:St(t,e)?[t]:Zr(to(t))}var at=qa;var Ja=1/0;function Ya(t){if(typeof t=="string"||bt(t))return t;var e=t+"";return e=="0"&&1/t==-Ja?"-0":e}var Y=Ya;function Va(t,e){e=at(e,t);for(var r=0,o=e.length;t!=null&&r<o;)t=t[Y(e[r++])];return r&&r==o?t:void 0}var Et=Va;function Qa(t,e,r){var o=t==null?void 0:Et(t,e);return o===void 0?r:o}var eo=Qa;function Xa(t,e){for(var r=-1,o=e.length,n=t.length;++r<o;)t[n+r]=e[r];return t}var Lt=Xa;var ro=I?I.isConcatSpreadable:void 0;function Za(t){return S(t)||vt(t)||!!(ro&&t&&t[ro])}var oo=Za;function no(t,e,r,o,n){var s=-1,i=t.length;for(r||(r=oo),n||(n=[]);++s<i;){var a=t[s];e>0&&r(a)?e>1?no(a,e-1,r,o,n):Lt(n,a):o||(n[n.length]=a)}return n}var so=no;var tp=ne(Object.getPrototypeOf,Object),io=tp;function ep(){this.__data__=new nt,this.size=0}var ao=ep;function rp(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r}var po=rp;function op(t){return this.__data__.get(t)}var fo=op;function np(t){return this.__data__.has(t)}var lo=np;var sp=200;function ip(t,e){var r=this.__data__;if(r instanceof nt){var o=r.__data__;if(!st||o.length<sp-1)return o.push([t,e]),this.size=++r.size,this;r=this.__data__=new mt(o)}return r.set(t,e),this.size=r.size,this}var uo=ip;function It(t){var e=this.__data__=new nt(t);this.size=e.size}It.prototype.clear=ao;It.prototype.delete=po;It.prototype.get=fo;It.prototype.has=lo;It.prototype.set=uo;var Ot=It;function ap(t,e){for(var r=-1,o=t==null?0:t.length,n=0,s=[];++r<o;){var i=t[r];e(i,r,t)&&(s[n++]=i)}return s}var co=ap;function pp(){return[]}var se=pp;var fp=Object.prototype,lp=fp.propertyIsEnumerable,mo=Object.getOwnPropertySymbols,up=mo?function(t){return t==null?[]:(t=Object(t),co(mo(t),function(e){return lp.call(t,e)}))}:se,ie=up;var cp=Object.getOwnPropertySymbols,mp=cp?function(t){for(var e=[];t;)Lt(e,ie(t)),t=io(t);return e}:se,go=mp;function dp(t,e,r){var o=e(t);return S(t)?o:Lt(o,r(t))}var ae=dp;function gp(t){return ae(t,Rt,ie)}var Ke=gp;function hp(t){return ae(t,kr,go)}var ho=hp;var xp=O(F,"DataView"),pe=xp;var yp=O(F,"Promise"),fe=yp;var wp=O(F,"Set"),le=wp;var xo="[object Map]",bp="[object Object]",yo="[object Promise]",wo="[object Set]",bo="[object WeakMap]",_o="[object DataView]",_p=tt(pe),Ap=tt(st),Cp=tt(fe),Pp=tt(le),vp=tt(Xt),dt=M;(pe&&dt(new pe(new ArrayBuffer(1)))!=_o||st&&dt(new st)!=xo||fe&&dt(fe.resolve())!=yo||le&&dt(new le)!=wo||Xt&&dt(new Xt)!=bo)&&(dt=function(t){var e=M(t),r=e==bp?t.constructor:void 0,o=r?tt(r):"";if(o)switch(o){case _p:return _o;case Ap:return xo;case Cp:return yo;case Pp:return wo;case vp:return bo}return e});var Ue=dt;var Rp=F.Uint8Array,qe=Rp;var Sp="__lodash_hash_undefined__";function Tp(t){return this.__data__.set(t,Sp),this}var Ao=Tp;function Fp(t){return this.__data__.has(t)}var Co=Fp;function ue(t){var e=-1,r=t==null?0:t.length;for(this.__data__=new mt;++e<r;)this.add(t[e])}ue.prototype.add=ue.prototype.push=Ao;ue.prototype.has=Co;var Po=ue;function Hp(t,e){for(var r=-1,o=t==null?0:t.length;++r<o;)if(e(t[r],r,t))return!0;return!1}var vo=Hp;function Ep(t,e){return t.has(e)}var Ro=Ep;var Lp=1,Ip=2;function Op(t,e,r,o,n,s){var i=r&Lp,a=t.length,p=e.length;if(a!=p&&!(i&&p>a))return!1;var f=s.get(t),l=s.get(e);if(f&&l)return f==e&&l==t;var u=-1,d=!0,h=r&Ip?new Po:void 0;for(s.set(t,e),s.set(e,t);++u<a;){var g=t[u],y=e[u];if(o)var C=i?o(y,g,u,e,t,s):o(g,y,u,t,e,s);if(C!==void 0){if(C)continue;d=!1;break}if(h){if(!vo(e,function(H,w){if(!Ro(h,w)&&(g===H||n(g,H,r,o,s)))return h.push(w)})){d=!1;break}}else if(!(g===y||n(g,y,r,o,s))){d=!1;break}}return s.delete(t),s.delete(e),d}var ce=Op;function kp(t){var e=-1,r=Array(t.size);return t.forEach(function(o,n){r[++e]=[n,o]}),r}var So=kp;function jp(t){var e=-1,r=Array(t.size);return t.forEach(function(o){r[++e]=o}),r}var To=jp;var Dp=1,Gp=2,Np="[object Boolean]",$p="[object Date]",Mp="[object Error]",Bp="[object Map]",zp="[object Number]",Wp="[object RegExp]",Kp="[object Set]",Up="[object String]",qp="[object Symbol]",Jp="[object ArrayBuffer]",Yp="[object DataView]",Fo=I?I.prototype:void 0,Je=Fo?Fo.valueOf:void 0;function Vp(t,e,r,o,n,s,i){switch(r){case Yp:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case Jp:return!(t.byteLength!=e.byteLength||!s(new qe(t),new qe(e)));case Np:case $p:case zp:return Ct(+t,+e);case Mp:return t.name==e.name&&t.message==e.message;case Wp:case Up:return t==e+"";case Bp:var a=So;case Kp:var p=o&Dp;if(a||(a=To),t.size!=e.size&&!p)return!1;var f=i.get(t);if(f)return f==e;o|=Gp,i.set(t,e);var l=ce(a(t),a(e),o,n,s,i);return i.delete(t),l;case qp:if(Je)return Je.call(t)==Je.call(e)}return!1}var Ho=Vp;var Qp=1,Xp=Object.prototype,Zp=Xp.hasOwnProperty;function tf(t,e,r,o,n,s){var i=r&Qp,a=Ke(t),p=a.length,f=Ke(e),l=f.length;if(p!=l&&!i)return!1;for(var u=p;u--;){var d=a[u];if(!(i?d in e:Zp.call(e,d)))return!1}var h=s.get(t),g=s.get(e);if(h&&g)return h==e&&g==t;var y=!0;s.set(t,e),s.set(e,t);for(var C=i;++u<p;){d=a[u];var H=t[d],w=e[d];if(o)var P=i?o(w,H,d,e,t,s):o(H,w,d,t,e,s);if(!(P===void 0?H===w||n(H,w,r,o,s):P)){y=!1;break}C||(C=d=="constructor")}if(y&&!C){var E=t.constructor,R=e.constructor;E!=R&&"constructor"in t&&"constructor"in e&&!(typeof E=="function"&&E instanceof E&&typeof R=="function"&&R instanceof R)&&(y=!1)}return s.delete(t),s.delete(e),y}var Eo=tf;var ef=1,Lo="[object Arguments]",Io="[object Array]",me="[object Object]",rf=Object.prototype,Oo=rf.hasOwnProperty;function of(t,e,r,o,n,s){var i=S(t),a=S(e),p=i?Io:Ue(t),f=a?Io:Ue(e);p=p==Lo?me:p,f=f==Lo?me:f;var l=p==me,u=f==me,d=p==f;if(d&&Nt(t)){if(!Nt(e))return!1;i=!0,l=!1}if(d&&!l)return s||(s=new Ot),i||re(t)?ce(t,e,r,o,n,s):Ho(t,e,p,r,o,n,s);if(!(r&ef)){var h=l&&Oo.call(t,"__wrapped__"),g=u&&Oo.call(e,"__wrapped__");if(h||g){var y=h?t.value():t,C=g?e.value():e;return s||(s=new Ot),n(y,C,r,o,s)}}return d?(s||(s=new Ot),Eo(t,e,r,o,n,s)):!1}var ko=of;function jo(t,e,r,o,n){return t===e?!0:t==null||e==null||!B(t)&&!B(e)?t!==t&&e!==e:ko(t,e,r,o,jo,n)}var de=jo;var nf=1,sf=2;function af(t,e,r,o){var n=r.length,s=n,i=!o;if(t==null)return!s;for(t=Object(t);n--;){var a=r[n];if(i&&a[2]?a[1]!==t[a[0]]:!(a[0]in t))return!1}for(;++n<s;){a=r[n];var p=a[0],f=t[p],l=a[1];if(i&&a[2]){if(f===void 0&&!(p in t))return!1}else{var u=new Ot;if(o)var d=o(f,l,p,t,e,u);if(!(d===void 0?de(l,f,nf|sf,o,u):d))return!1}}return!0}var Do=af;function pf(t){return t===t&&!z(t)}var ge=pf;function ff(t){for(var e=Rt(t),r=e.length;r--;){var o=e[r],n=t[o];e[r]=[o,n,ge(n)]}return e}var Go=ff;function lf(t,e){return function(r){return r==null?!1:r[t]===e&&(e!==void 0||t in Object(r))}}var he=lf;function uf(t){var e=Go(t);return e.length==1&&e[0][2]?he(e[0][0],e[0][1]):function(r){return r===t||Do(r,t,e)}}var No=uf;function cf(t,e){return t!=null&&e in Object(t)}var $o=cf;function mf(t,e,r){e=at(e,t);for(var o=-1,n=e.length,s=!1;++o<n;){var i=Y(e[o]);if(!(s=t!=null&&r(t,i)))break;t=t[i]}return s||++o!=n?s:(n=t==null?0:t.length,!!n&&Pt(n)&&At(i,n)&&(S(t)||vt(t)))}var Mo=mf;function df(t,e){return t!=null&&Mo(t,e,$o)}var Bo=df;var gf=1,hf=2;function xf(t,e){return St(t)&&ge(e)?he(Y(t),e):function(r){var o=eo(r,t);return o===void 0&&o===e?Bo(r,t):de(e,o,gf|hf)}}var zo=xf;function yf(t){return function(e){return e?.[t]}}var Wo=yf;function wf(t){return function(e){return Et(e,t)}}var Ko=wf;function bf(t){return St(t)?Wo(Y(t)):Ko(t)}var Uo=bf;function _f(t){return typeof t=="function"?t:t==null?_t:typeof t=="object"?S(t)?zo(t[0],t[1]):No(t):Uo(t)}var xe=_f;function Af(t){return function(e,r,o){for(var n=-1,s=Object(e),i=o(e),a=i.length;a--;){var p=i[t?a:++n];if(r(s[p],p,s)===!1)break}return e}}var qo=Af;var Cf=qo(),Jo=Cf;function Pf(t,e){return t&&Jo(t,e,Rt)}var Yo=Pf;var vf=1/0;function Rf(t){var e=t==null?0:t.length;return e?so(t,vf):[]}var Ye=Rf;function Sf(t,e){var r={};return e=xe(e,3),Yo(t,function(o,n,s){Zt(r,n,e(o,n,s))}),r}var gt=Sf;function Tf(t,e,r,o){if(!z(t))return t;e=at(e,t);for(var n=-1,s=e.length,i=s-1,a=t;a!=null&&++n<s;){var p=Y(e[n]),f=r;if(p==="__proto__"||p==="constructor"||p==="prototype")return t;if(n!=i){var l=a[p];f=o?o(l,p,a):void 0,f===void 0&&(f=z(l)?l:At(e[n+1])?[]:{})}br(a,p,f),a=a[p]}return t}var Vo=Tf;function Ff(t,e,r){for(var o=-1,n=e.length,s={};++o<n;){var i=e[o],a=Et(t,i);r(a,i)&&Vo(s,at(i,t),a)}return s}var Qo=Ff;function Hf(t,e){if(t==null)return{};var r=Yt(ho(t),function(o){return[o]});return e=xe(e),Qo(t,r,function(o,n){return e(o,n[0])})}var Ve=Hf;/**
 * @license
 * Lodash (Custom Build) <https://lodash.com/>
 * Build: `lodash modularize exports="es" -o ./`
 * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */var T={blueBright:t=>ye.blue_bt(t),green:t=>ye.green(t),red:t=>ye.red(t),yellow:t=>ye.yellow(t)};var W=t=>(console.info(`${T.blueBright("RUN ")} ${t}`),{success:e=>console.info(`${T.green("SUCC")} ${t}${e?`
  ${e.split(`
`).map(r=>`
    ${r}`).join("").trim()}`:""}`),fail:e=>console.error(`${T.red("ERR ")} ${t} - ${e}`),warn:e=>console.warn(`${T.yellow("WARN")} ${t} - ${e}`)});var K=(t,e=/[\n,; ]/)=>typeof t=="string"?t.split(e).map(r=>r.trim()).filter(_t):Ye(t.map(r=>r.split(e).map(o=>o.trim()))).filter(_t),Mt=t=>t();var Xo=new Map,Q=(t,e)=>(Xo.set(t,e),e),Zo=new V,Ef=()=>Zo.getStore()??Mt,we=Q("git",new V),be=Q("astGrepNodeContext",new V),tn=Q("describeContext",new V),Lf=Q("migrateContext",new V),G=Q("cwdContext",new V),_e=Q("parentCwdContext",new V),pt=Q("fileContext",new V),X=Q("repositoryContext",new V),en=Q("repositoriesContext",new V),If=()=>[...Xo.entries()].map(([t,e])=>[t,e.getStore()]).filter(([,t])=>typeof t<"u"),L=()=>{let t=be.getStore();return Bt(t,"No ast-grep node context found"),t},v=()=>G.getStore()??{cwd:process.cwd()},Qe=()=>_e.getStore()??{cwd:process.cwd()},b=()=>{let t=pt.getStore();return Bt(t,"No file context found"),t},zt=()=>{let t=we.getStore();return t||new wt({repository:"",id:""})},Xe=()=>{let t=X.getStore();return Bt(t,"No repository context found"),t},Of=()=>{let t=en.getStore();return Bt(t,"No repositories context found"),t},kf=()=>{let t=tn.getStore();return Bt(t,"No describe context found"),t};import{AsyncLocalStorage as rr}from"node:async_hooks";import{createHash as jf}from"node:crypto";var ft=class extends Promise{#e;#t;constructor(e){super(r=>{r()}),this.#e=e}static from(e){return new ft(r=>{r(e())})}static resolve(e){return new ft(r=>{r(e)})}static reject(e){return new ft((r,o)=>{o(e)})}then(e,r){return this.#t??=new Promise(this.#e),this.#t.then(e,r)}catch(e){return this.#t=this.#t||new Promise(this.#e),this.#t.catch(e)}};function Df(t){let e=jf("sha1");return e.update(JSON.stringify(t)),e.digest("hex")}var er=class{name;hash;arguments;children;constructor(e,r,o){this.name=e,this.arguments=o.map(n=>String(n)),this.hash=Df({name:e,fn:r.toString(),args:o}),this.children=[]}},rn=new rr,Ae=new rr,tr=new rr,on={children:[]},nn=()=>on;function m(t,e){return(...r)=>{let o=Ae.getStore(),n=new er(t,e.toString(),r);return o?o.children.push(n):on.children.push(n),rn.run(n,e,...r)}}var c=class{constructor(e){this.name=e;this._context=rn.getStore(),this._parentWrapper=tr.getStore()??Mt}_init;_helpers;_return;_context;_copyHelpersToPromise=!0;_executor;_parentWrapper;_callback;_arguments;_done;parentArgs=[];childArgs=[];initiated=!1;setParentArgs(...e){return this.parentArgs=e,this}getChildArgs(){return this.childArgs}getChildArg(e){return this.childArgs.find(r=>typeof r[e]<"u")?.[e]}doNotCopyHelpersToPromise(){return this._copyHelpersToPromise=!1,this}init(e){return e&&(this._init=D(e)),this}done(e){return this._done=e,this}arguments(e){return this._arguments=e,this}getArguments(){return this._arguments?.(this)}helpers(e){return this._helpers=e,this}callback(e){return this._callback=e,this}wrappedHelpers(){return gt(typeof this._helpers=="function"?this._helpers(this):this._helpers,e=>(...r)=>Ae.run(this._context,()=>tr.run(this.context(),()=>e(...r))))}wrapHelpers(e){return gt(e,r=>(...o)=>Ae.run(this._context,()=>tr.run(this.context(),()=>r(...o))))}context(){return(e,...r)=>(this.childArgs=r,this._parentWrapper(()=>(this._executor??Mt)(async()=>(this._init&&!this.initiated&&(this.initiated=!0,await this._init(this)),this._callback&&await Ae.run(this._context,this._callback,this),e?.()),this),...this.parentArgs))}return(e){return this._return=e,this}executor(e){return this._executor=e,this}run(){let e=new ft((r,o)=>{(async()=>{let n,s=!1;return await this.context()(async()=>{n=await this._return?.(this),s=!0}),s||(n=await this._return?.(this)),n})().then(r).catch(o)});if(this._copyHelpersToPromise){let r=this.wrappedHelpers();for(let o in r)e[o]=r[o]}return e}};import*as sn from"node:child_process";import*as an from"node:fs";import or from"tree-kill";var rt=(t,e,r={})=>{let o=r.cwd??process.cwd();return an.existsSync(o)?new Promise((n,s)=>{let{doNotThrowError:i,printOutput:a,printNewline:p,watch:f,doNotKill:l,filterEnv:u,...d}=r,h=Ve({...process.env,...d?.env,FORCE_COLOR:""},(R,j)=>u?.(j,R)??!0),g=sn.spawn(t,e,{...d,cwd:o,env:h}),y=g.pid,C=[],H=[],w,P=!1,E=l?()=>{P=!0,or(y,"SIGKILL"),g.stdin.end(),g.stdout.destroy(),g.stderr.destroy()}:Ge;g.stdout.on("data",R=>{let j=R.toString();if(H.push(j),j.includes("Proceed")&&g.stdin.write(`y
`),f&&j.includes(f)){l||(P=!0,or(y,"SIGKILL"),g.stdin.end(),g.stdout.destroy(),g.stderr.destroy()),n({stdout:H,stderr:C,error:w,kill:E});return}P||(a&&process.stdout.write(j),p&&g.stdin.write(`
`))}),g.stderr.on("data",R=>{let j=R.toString();if(C.push(j),f&&j.includes(f)){l||(P=!0,or(y,"SIGKILL"),g.stdin.end(),g.stdout.destroy(),g.stderr.destroy()),n({stdout:H,stderr:C,error:w,kill:E});return}P||(a&&process.stdout.write(j),p&&g.stdin.write(`
`))}),g.on("error",R=>{w=R}),g.on("close",R=>{if(!i){if(w){s(new Error(`Failed to execute command "${t} ${e.join(" ")}" with error ${w.toString()}`));return}if(R){console.error(H.join(`
`)),console.error(C.join(`
`)),s(new Error(`Failed to execute command "${t} ${e.join(" ")}" with code ${R}`));return}}n({stdout:H,stderr:C,error:w,kill:E})})}):Promise.reject(new Error(`Provided directory: ${o} does not exist`))};function Gf(t,e){return new c("exec").arguments(()=>({command:t,args:e})).helpers(Nf).executor(async(r,o)=>{let{cwd:n}=v(),{command:s,args:i}=o.getArguments();console.log(`${T.blueBright(`${s} ${i?.join(" ")??""}`)} ${n}`),await rt(s,i??[],{cwd:n,doNotThrowError:!0}),await r?.()}).return(r=>r.wrappedHelpers()).run()}var U=m("exec",Gf),Nf={exec:U,codemod:q};function $f(t,e){return new c("codemod").arguments(()=>({name:t,args:e})).helpers(Mf).executor(async(r,o)=>{let{cwd:n}=v(),s=Object.entries(o.getArguments().args??{}).reduce((i,[a,p])=>(Array.isArray(p)?p.forEach(f=>i.push(`--${a}=${f}`)):i.push(`--${a}=${p}`),i),["--no-interactive"]);console.log(`${T.blueBright(`codemod ${t} ${s.join(" ")}`)} ${n}`),await rt("npx",["codemod@latest",t,...s],{cwd:n,doNotThrowError:!0,printOutput:!0}),await r?.()}).return(r=>r.wrappedHelpers()).run()}var q=m("codemod",$f),Mf={codemod:q,exec:U};import*as Kt from"node:path";import*as In from"glob";import*as cn from"node:child_process";import*as mn from"node:fs/promises";import*as Te from"node:path";import*as dn from"node:util";import{Lang as x,SgNode as al,parse as pl}from"@ast-grep/napi";import*as gn from"yaml";import Yf from"openai";import*as Pe from"node:fs/promises";import{extname as Bf}from"node:path";var zf=new Map([["ts","typescript"],["tsx","typescript"],["js","babel"],["jsx","babel"],["json","json"],["json5","json5"],["jsonc","json"],["css","css"],["scss","scss"],["less","less"],["graphql","graphql"],["md","markdown"],["mdx","mdx"],["html","html"],["vue","vue"],["yaml","yaml"],["yml","yaml"]]),Wf={tabWidth:4,useTabs:!0,semi:!0,singleQuote:!0,quoteProps:"as-needed",trailingComma:"all",bracketSpacing:!0,arrowParens:"always",endOfLine:"lf",parser:"typescript"},Kf=async t=>{let{resolveConfig:e}=await import("prettier"),r=await e(t,{editorconfig:!1});(r===null||Object.keys(r).length===0)&&(r=Wf);let o=zf.get(Bf(t).slice(1))??"typescript";return{...r,parser:o}},pn=async(t,e)=>{let r=e.replace(/\/\*\* \*\*\//gm,"");try{let{format:o}=await import("prettier"),n=await Kf(t);return await o(r,n)}catch{return r}};import{glob as Vy}from"glob";import Ce from"jscodeshift";var fn=t=>({j:t?Ce.withParser(t):Ce,jscodeshift:t?Ce.withParser(t):Ce,stats:()=>{console.error("The stats function was called, which is not supported on purpose")},report:()=>{console.error("The report function was called, which is not supported on purpose")}});import{convertChangesToDMP as Uf,diffLines as qf}from"diff";import Jf from"magic-string";var sw=process.argv.includes("--format"),lt=class extends yt{_contents=void 0;_magicString=void 0;_contentsChanged=!1;_oldContents=void 0;importsUpdates=[];get file(){return this.get("file")}async contents(){return typeof this._contents>"u"&&(this._contents=await Pe.readFile(this.file,{encoding:"utf-8"}),this._oldContents=this._contents),typeof this._magicString<"u"?this._magicString.toString():this._contents}setContents(e){this._contents=e,this._magicString=void 0,this._contentsChanged=!0}async magicString(){return typeof this._magicString>"u"&&(this._magicString=new Jf(await this.contents())),this._magicString}async update({start:e,end:r,replacement:o}){(await this.magicString()).update(e,r,o)}async save({format:e}={}){let r;if(this._magicString?.hasChanged()?r=this._magicString.toString():this._contentsChanged&&(r=this._contents),typeof r=="string"){let o=this._oldContents,n=e?await pn(this.file,r):r;await Pe.writeFile(this.file,n),this._oldContents=void 0,this._contents=void 0,this._magicString=void 0,this._contentsChanged=!1,console.error(`${T.blueBright("FILE")} ${this.file}`);let s=Uf(qf(o??n,n));for(let[i,a]of s)switch(i){case-1:process.stdout.write(T.red(a));break;case 1:process.stdout.write(T.green(a));break}process.stdout.write(`
`)}}get extension(){return this.file.split(".").pop()}};var Vf=`
You are a meticulous engineer assigned to migrate a codebase by updating its code when necessary.

When you write code, the code works on the first try, and is complete. Take into account the current repository's language, code style, and dependencies.

You will be given a Context File, a Migration Description and a Source File. You will rewrite the Source File in order to apply the changes described in the Migration Description.

You will use a Context File to understand the codebase and the Migration Description to apply the changes.
Context file will be surrounded by triple single quotes like this:
'''
context file here
'''

If a line of code is not affected by the migration, you should keep it as it is.

Source file will be split into multiple parts, each part starts with a comment like this:
// codemod#ai#0
part code here
// codemod#ai#0
where 0 is a number that represents the part number.

You must print the modified Source File in the following format:

\`\`\`
modified Source File
\`\`\`

You must preserve parts naming and order.
`,Wt=class{constructor(e){this.userPrompt=e}beforesSamples={};query;_usage={completion_tokens:0,prompt_tokens:0,total_tokens:0};addBefore(e){this.beforesSamples[e.filename]??=[],this.beforesSamples[e.filename]?.push(e)}get prompts(){return gt(this.beforesSamples,e=>`
You are migrating a code, which matches ast-grep pattern:
${this.query??""}

Context file:
'''
${e[0]?.contents}
'''

${this.userPrompt}

${e.map((r,o)=>`
// codemod#ai#${o}
${r.text}
// codemod#ai#${o}

`).join("")}`)}get usage(){return this._usage}static getReplacements(e){let r=e?.match(/```([\s\S]*?)```/g)?.[0]?.replace(/^```/g,"")?.replace(/```$/g,""),o=[],n=r?.split(`
`)??[],s=-1,i="";for(let a of n){let p=Number.parseInt(a.match(/\/\/ codemod#ai#(\d+)/)?.[1]??"",10);if(!Number.isNaN(p)){s===p?(o.push(i),i=""):s=p;continue}i+=a}return o}async execute(){let e=process.argv.find(o=>o.startsWith("--OPENAI_API_KEY="))?.replace("--OPENAI_API_KEY=","");e||(console.error('Please set OPENAI_API_KEY environment variable like "codemod ... --OPENAI_API_KEY=YOUR_API_KEY"'),process.exit(1));let r=new Yf({apiKey:e});await Promise.all(Object.entries(this.prompts).map(async([o,n])=>{let s=await r.chat.completions.create({model:"gpt-4-turbo",seed:7,messages:[{role:"system",content:Vf},{role:"user",content:n}],temperature:.001,n:1}),i=s?.usage;i&&(this._usage.completion_tokens+=i.completion_tokens,this._usage.prompt_tokens+=i.prompt_tokens,this._usage.total_tokens+=i.total_tokens);let a=s?.choices[0]?.message.content,p=Wt.getReplacements(a),f=[],l=this.beforesSamples[o]??[];for(let u=0;u<l.length;u++){let d=l[u],h=p[u];f.push({startPosition:d.startPosition,endPosition:d.endPosition,text:h})}if(f.length)try{let u=new lt({file:o});for(let d of f)await u.update({start:d.startPosition,end:d.endPosition,replacement:d.text});await u.save()}catch{}})),console.log(`Codemod2.0 ${T.blueBright("usage")}: ${T.green("Prompt tokens")}(${this._usage.prompt_tokens}), ${T.green("Completion tokens")}(${this._usage.completion_tokens}), ${T.green("Total tokens")}(${this._usage.total_tokens})`)}};function Qf(t){let e=typeof t=="string"?t:t.join(""),r=new Wt(e);return new c("ai").arguments(()=>({prompt:e})).helpers(Xf).executor(async()=>{let{node:o,query:n}=L(),s=b(),i=o.range();r.query=typeof n=="string"?n:JSON.stringify(n),r.addBefore({filename:s.file,contents:await s.contents(),startPosition:i.start.index,endPosition:i.end.index,text:o.text()})}).return(async o=>(await r.execute(),o.wrappedHelpers())).run()}var ve=m("ai",Qf),Xf={};function Zf(){let t=!1;return new c("exists").executor(async(e,r)=>{t=!0,await e?.()}).return(()=>t).run()}var Re=m("exists",Zf);function tl(t){let e=[];return new c("map").helpers(ln).arguments(()=>({callback:t})).executor(async(r,o)=>{let{callback:n}=o.getArguments(),s=await n(ln);e.push(s),await r?.()}).return(()=>e).run()}var kt=m("map",tl),ln={getNode:()=>L().node,getMatch:t=>L().node.getMatch(t),getMultipleMatches:t=>L().node.getMultipleMatches(t)};var el={getNode:()=>L().node,getMatch:t=>L().node.getMatch(t),getMultipleMatches:t=>L().node.getMultipleMatches(t)};function rl(t){return new c("replace").arguments(()=>{let e;return typeof t=="string"?e=t:Array.isArray(t)&&(e=t.join("")),{replacement:e,callback:typeof t=="function"?t:void 0}}).helpers(()=>ol).return(e=>e.wrappedHelpers()).executor(async(e,r)=>{let o=b(),{node:n}=L(),{callback:s,replacement:i}=r.getArguments();if(s&&(i=await s(r.wrapHelpers(el))),i){let a=i.replace(/(\$\$)?\$([A-Z]+)/gm,(f,l,u)=>l?n?.getMultipleMatches(u).map(d=>d.text()).join(" "):n.getMatch(u)?.text()||""),p=n.range();await o.update({start:p.start.index,end:p.end.index,replacement:a})}}).run()}var Se=m("replace",rl),ol={map:kt};var nl={getNode:()=>L().node,getMatch:t=>L().node.getMatch(t),getMultipleMatches:t=>L().node.getMultipleMatches(t)};function sl(t){return new c("replace").arguments(()=>({callback:t})).helpers(()=>il).return(e=>e.wrappedHelpers()).executor(async(e,r)=>{let{callback:o}=r.getArguments();await o(r.wrapHelpers(nl))&&await e()}).run()}var nr=m("filter",sl),il={map:kt,filter:nr,replace:Se,ai:ve,exists:Re};var fl={css:x.Css,html:x.Html,js:x.JavaScript,jsx:x.JavaScript,mjs:x.JavaScript,mts:x.TypeScript,cjs:x.JavaScript,cts:x.TypeScript,ts:x.TypeScript,"d.ts":x.TypeScript,tsx:x.Tsx,sh:x.Bash,c:x.C,h:x.C,cpp:x.Cpp,hpp:x.Cpp,cs:x.CSharp,dart:x.Dart,ex:x.Elixir,exs:x.Elixir,go:x.Go,java:x.Java,json:x.Json,kt:x.Kotlin,lua:x.Lua,php:x.Php,py:x.Python,py3:x.Python,rb:x.Ruby,rs:x.Rust,scala:x.Scala,swift:x.Swift,sql:x.Sql,psql:x.Sql,mysql:x.Sql},ll=dn.promisify(cn.execFile),ul=async(t,e)=>{let r=De.resolve("@ast-grep/cli/package.json"),{bin:o}=JSON.parse(await mn.readFile(r,"utf-8")),n=Te.join(Te.dirname(De.resolve("@ast-grep/cli/package.json")),o.sg);await ll(n,["scan","--update-all","--inline-rules",JSON.stringify(t),e])};function cl(t,e){return new c("astGrep").arguments(()=>{let r=t;return typeof t=="object"&&(r=Array.isArray(t)?t.join(""):t),{grep:r,callback:e}}).helpers(r=>{let{grep:o}=r.getArguments();return typeof o=="object"&&"id"in o?ml:un}).return(r=>r.wrappedHelpers()).executor(async(r,o)=>{let n=b(),{grep:s,callback:i}=o.getArguments(),a;if(typeof s=="string")try{a=gn.parse(s)}catch{a={rule:{pattern:{context:s,strictness:"relaxed"}}}}else a=s;if(typeof s=="object"&&"id"in s)await ul(a,n.file);else{if(!n.extension)return;let p=fl[n.extension];if(!p){console.warn(`${T.yellow("WARN")} Unsupported file extension: ${n.extension}`);return}let f=pl(p,await n.contents()).root().findAll(a).reverse(),l={query:s};for(let u of f)r&&(l.node=u,await be.run(l,async()=>(await i?.(un),await r())));await n.save()}}).run()}var k=m("astGrep",cl),un={replace:Se,map:kt,ai:ve,filter:nr,exists:Re},ml={astGrep:k};import*as N from"node:fs/promises";import*as Z from"node:path";import*as A from"node:path/posix";import*as xn from"glob";var hn=["js","jsx","ts","tsx","cjs","mjs"],dl=(t,e)=>{for(let[r,o]of Object.entries(e))if(t===o)return r},gl=async(t,e)=>{if(t in e)return e[t];let r=t.indexOf("?");if(r!==-1){let o=t.slice(0,r);if(o in e)return`${e[o]}?${t.slice(r+1)}`}for(let o of hn){let n=`${t}.${o}`;if(n in e)return A.format({...A.parse(e[n]),base:void 0,ext:void 0})}try{if((await N.stat(t)).isDirectory())for(let o of hn){let n=`${A.join(t,"index")}.${o}`;if(n in e)return A.format({...A.parse(e[n]),base:void 0,ext:void 0,name:void 0})}}catch{}},hl=async(t,e,r)=>{if(r?.startsWith(".")&&!r.endsWith("package.json")){let o=dl(t,e),n=A.resolve(A.dirname(o??t),r),s=await gl(n,e)??n,i=A.join(A.relative(A.dirname(t),A.dirname(s)),A.basename(s));i.startsWith(".")||(i=`./${i}`);let a=A.extname(i);return a===".ts"?a=".js":(a===".tsx"||a===".jsx")&&(a=void 0),i=A.format({...A.parse(i),base:void 0,ext:a}),r!==i?i:r}return r};function xl(t){return new c("move").arguments(()=>({target:t})).helpers(yl).executor(async(e,r)=>{let{target:o}=r.getArguments(),{cwd:n}=v(),s=pt.getStore(),i=[],a=!1;s?(a=!0,i=[Z.basename(s.file)]):i=await xn.glob("**/*.*",{cwd:n,nodir:!0,ignore:["**/node_modules/**","**/.git/**","**/dist/**","**/build/**"]});let p={};for(let f of i){let l=Z.resolve(n,f),u=Z.resolve(o,...a?[]:[Z.basename(n)],f);console.log(`Moving ${l} to ${u}`),await N.mkdir(Z.dirname(u),{recursive:!0}),await N.rename(l,u),u.match(/\.(ts|js|tsx|jsx|cjs|mjs)$/)&&(p[l]=u);try{await N.readdir(Z.dirname(l)).then(d=>d.length===0)&&await N.rmdir(Z.dirname(l))}catch{}}try{await N.readdir(n).then(f=>f.length===0)&&await N.rmdir(n)}catch{}await G.run(Qe(),async()=>await $("**/*.{js,jsx,ts,tsx,cjs,mjs}").jsFam(async({astGrep:f})=>{let l=b().file;await f({rule:{any:[{kind:"string_fragment",inside:{kind:"string",inside:{any:[{kind:"import_statement"},{kind:"export_statement"}]}}},{kind:"string_fragment",inside:{kind:"string",inside:{kind:"arguments",inside:{kind:"call_expression",regex:"^require"}}}}]}}).replace(async({getNode:u})=>await hl(l,p,u().text()))}))}).return(e=>e.wrappedHelpers()).run()}var Fe=m("move",xl),yl={};import{ts as _l}from"@ast-grep/napi";function He(t){return k({rule:{any:[{pattern:t.replace(/"/g,"'")},{pattern:t.replace(/'/g,'"')}]}})}function wl(t){let e=fn("tsx");return new c("jscodeshift").arguments(()=>({callback:t})).helpers(()=>bl).return(r=>r.wrappedHelpers()).executor(async(r,o)=>{let{callback:n}=o.getArguments(),s=b(),i=await s.contents();try{let a=await n({path:s.file,source:i},e,{});typeof a=="string"&&i!==a&&(s.setContents(a),await s.save())}catch(a){console.error(`jscodeshift error: ${a} in ${s.file}`)}await r()}).run()}var yn=m("jscodeshift",wl),bl={};function Al(t){return new c("jsFam").arguments(()=>({callback:t})).helpers(wn).setParentArgs({defaultGlob:"**/*.{js,jsx,ts,tsx,cjs,mjs,cts,mts,d.ts}"}).return(e=>e.wrappedHelpers()).executor(async(e,r)=>{let{callback:o}=r.getArguments();o&&await o(wn),await e();let{importsUpdates:n}=b(),s=a=>({from:a.getMatch("FROM")?.text(),imports:a.getMultipleMatches("IMPORTS").filter(p=>p.kind()!==",").map(p=>p.text())}),i={rule:{any:[{pattern:"import { $$$IMPORTS } from '$FROM'"},{pattern:'import { $$$IMPORTS } from "$FROM"'}]}};if(n.length)for(let{type:a,import:p}of n){let f=_l.parse(p).root().findAll(i);for(let l of f){let u=s(l);await k(i).replace(({getNode:d})=>{let h=s(d()),g=!1;if(h.from===u.from)for(let y of u.imports)a==="add"?h.imports.includes(y)||(g=!0,h.imports.push(y)):a==="remove"&&h.imports.includes(y)&&(g=!0,h.imports=h.imports.filter(C=>C!==y));if(g)return`import { ${h.imports.join(", ")} } from "${h.from}"`})}}}).run()}var bn=m("jsFam",Al),wn={astGrep:k,getImports:He,addImport:t=>{b().importsUpdates.push({type:"add",import:t})},removeImport:t=>{b().importsUpdates.push({type:"remove",import:t})},jscodeshift:yn};function Cl(t){let e=[];return new c("map").helpers(_n).arguments(()=>({callback:t})).executor(async(r,o)=>{let{callback:n}=o.getArguments(),s=await n(_n);e.push(s),await r?.()}).return(()=>e).run()}var An=m("map",Cl),_n={getContents:async()=>JSON.parse(await b().contents())};import Pl from"detect-indent";import{detectNewline as vl}from"detect-newline";function Rl(t){return new c("update").helpers(Sl).arguments(()=>({callback:t})).executor(async(e,r)=>{let{callback:o}=r.getArguments(),n=b(),s=await n.contents(),i=Pl(s).indent||"  ",a=vl(s)||`
`,p=s.slice(-a.length),f=a.localeCompare(p)===0?a:"",l=await o(JSON.parse(s));n.setContents(JSON.stringify(l,null,i).concat(f)),await n.save(),await e?.()}).return(e=>e.wrappedHelpers()).run()}var Cn=m("update",Rl),Sl={};function Tl(t){return new c("json").arguments(()=>({callback:t})).helpers(Pn).setParentArgs({defaultGlob:"**/*.json"}).return(e=>e.wrappedHelpers()).executor(async(e,r)=>{let{callback:o}=r.getArguments();o&&await o(Pn),await e()}).run()}var vn=m("json",Tl),Pn={map:An,update:Cn};import*as Sn from"yaml";function Fl(t){let e=[];return new c("map").helpers(Rn).arguments(()=>({callback:t})).executor(async(r,o)=>{let{callback:n}=o.getArguments(),s=await n(Rn);e.push(s),await r?.()}).return(()=>e).run()}var Tn=m("map",Fl),Rn={getContents:async()=>Sn.parse(await b().contents())};import Hl from"detect-indent";import*as Ee from"yaml";function El(t){return new c("update").helpers(Ll).arguments(()=>({callback:t})).executor(async(e,r)=>{let{callback:o}=r.getArguments(),n=b(),s=await n.contents(),i=Hl(s).amount||2,a=await o(Ee.parse(s));n.setContents(Ee.stringify(a,{indent:i})),await n.save(),await e?.()}).return(e=>e.wrappedHelpers()).run()}var Fn=m("update",El),Ll={};function Il(t){return new c("yaml").arguments(()=>({callback:t})).helpers(Hn).setParentArgs({defaultGlob:"**/*.yaml"}).return(e=>e.wrappedHelpers()).executor(async(e,r)=>{let{callback:o}=r.getArguments();o&&await o(Hn),await e()}).run()}var En=m("yaml",Il),Hn={map:Tn,update:Fn};function Ol(t,e){return new c("files").arguments(r=>{let o=r.getChildArg("defaultGlob")??"**/*.*";return{globs:K(!t||typeof t=="function"?o:t,/[\n; ]/),callback:typeof t=="function"?t:e}}).helpers(Ln).executor(async(r,o)=>{let{globs:n,callback:s}=o.getArguments(),{cwd:i}=v(),a=n.filter(l=>Kt.isAbsolute(l)),p=n.filter(l=>!Kt.isAbsolute(l)),f=[...(await In.glob(p,{cwd:i,nodir:!0,ignore:["**/node_modules/**","**/.git/**","**/dist/**","**/build/**"]})).map(l=>Kt.join(i,l)),...a];for(let l of f)await pt.run(new lt({file:l}),async()=>{s&&await s(Ln),await r()})}).run()}var $=m("files",Ol),Ln={jsFam:bn,move:Fe,astGrep:k,yaml:En,json:vn};import*as $n from"node:fs/promises";import*as Ut from"node:path";import*as qt from"glob";import*as kn from"node:path";import{ts as kl}from"@ast-grep/napi";import*as jn from"glob";function jl(t,e){return new c("jsFiles").arguments(()=>({globs:K(!t||typeof t=="function"?"**/*.{js,jsx,ts,tsx,cjs,mjs}":t,/[\n; ]/),callback:typeof t=="function"?t:e})).helpers(On).executor(async(r,o)=>{let{globs:n,callback:s}=o.getArguments(),{cwd:i}=v(),a=await jn.glob(n,{cwd:i,nodir:!0,ignore:["**/node_modules/**","**/.git/**","**/dist/**","**/build/**"]});for(let p of a)await pt.run(new lt({file:kn.join(i,p)}),async()=>{s&&await s(On),await r();let{importsUpdates:f}=b(),l=d=>({from:d.getMatch("FROM")?.text(),imports:d.getMultipleMatches("IMPORTS").filter(h=>h.kind()!==",").map(h=>h.text())}),u={rule:{any:[{pattern:"import { $$$IMPORTS } from '$FROM'"},{pattern:'import { $$$IMPORTS } from "$FROM"'}]}};if(f.length)for(let{type:d,import:h}of f){let g=kl.parse(h).root().findAll(u);for(let y of g){let C=l(y);await k(u).replace(({getNode:H})=>{let w=l(H()),P=!1;if(w.from===C.from)for(let E of C.imports)d==="add"?w.imports.includes(E)||(P=!0,w.imports.push(E)):d==="remove"&&w.imports.includes(E)&&(P=!0,w.imports=w.imports.filter(R=>R!==E));if(P)return`import { ${w.imports.join(", ")} } from "${w.from}"`})}}})}).return(r=>r.wrappedHelpers()).run()}var ut=m("jsFiles",jl),On={astGrep:k,getImports:He,addImport:t=>{b().importsUpdates.push({type:"add",import:t})},removeImport:t=>{b().importsUpdates.push({type:"remove",import:t})}};function Dl(t){let e=[];return new c("map").helpers(Dn).executor(async()=>{let r=await t(Dn);e.push(r)}).return(()=>e).run()}var Gn=m("map",Dl),Dn={cwd:()=>v().cwd};function Gl(t,e){return new c("dirs").arguments(()=>{if(typeof t=="object"&&!Array.isArray(t)){let{dirs:n,...s}=t;return{params:{...s,dirs:K(n)},callback:e}}let r=K(t);return{params:{create:r.length===1&&!qt.hasMagic(r[0]),dirs:r},callback:e}}).helpers(Nn).executor(async(r,o)=>{let{params:{dirs:n,create:s,ignore:i}}=o.getArguments(),{cwd:a}=v(),p=await qt.glob(n,{cwd:a,ignore:i}),f=new Set;for(let l of p)f.has(l)||(f.add(l),await G.run({cwd:Ut.join(a,l)},r));if(s)for(let l of n)!qt.hasMagic(l)&&!f.has(l)&&(f.add(l),console.log(`Creating directory ${Ut.join(a,l)}`),await $n.mkdir(Ut.join(a,l),{recursive:!0}),await G.run({cwd:Ut.join(a,l)},r))}).callback(async r=>{let{callback:o}=r.getArguments();await o?.(Nn)}).return(r=>r.wrappedHelpers()).run()}var ht=m("dirs",Gl),Nn={dirs:ht,jsFiles:ut,codemod:q,exec:U,move:Fe,map:Gn,files:$};function Nl({force:t}={force:!0}){return new c("push").arguments(()=>({force:t})).helpers($l).executor(async e=>{let{repository:r,branch:o}=Xe(),{cwd:n}=v(),s=W(`Pushing to ${r}/tree/${o}`);try{await rt("git",["push",...t?["-f"]:[]],{cwd:n}),s.success()}catch(i){s.fail(i.toString())}await e()}).return(e=>e.wrappedHelpers()).run()}var ct=m("push",Nl),$l={};function Ml(t){return new c("commit").arguments(()=>({message:t})).helpers(Bl).executor(async(e,r)=>{let{message:o}=r.getArguments(),{cwd:n}=v(),s=X.getStore(),i=W(`Committing${s?` to ${s.repository}/tree/${s.branch}`:""}${o?` with message: ${JSON.stringify(o)}`:""}`);try{await rt("git",["add","."],{cwd:n});let{stdout:a}=await rt("git",["commit","-m",o],{cwd:n,doNotThrowError:!0});a.join("").match(/nothing to commit, working tree clean/gm)?i.warn("Nothing to commit"):i.success(a.join(""))}catch(a){i.fail(a.toString())}await e()}).return(e=>e.wrappedHelpers()).run()}var jt=m("commit",Ml),Bl={push:ct};function zl(t,e){let r=D((o,n,s,i)=>n.checkout({branch:s,force:i}));return new c("branch").arguments(()=>({branchArg:typeof t=="string"?{branch:t,force:!0}:t,callback:e})).helpers(Mn).executor(async(o,n)=>{let{branchArg:s}=n.getArguments(),i=zt();await r(`${i.get("id")}-${s.branch}-${String(s.force)}`,i,s.branch,s.force),await o()}).callback(async o=>{let{callback:n}=o.getArguments();await n?.(Mn)}).return(o=>o.wrappedHelpers()).run()}var Le=m("branch",zl),Mn={jsFiles:ut,commit:jt,push:ct,dirs:ht,codemod:q,exec:U,files:$};import*as J from"node:fs/promises";import*as Bn from"node:os";import*as zn from"node:path";import Wl from"@sindresorhus/slugify";import Kl from"filenamify";import*as Ul from"glob";var ql="cm",Wn=(...t)=>{let e=t.map(o=>{let n=Wl(o);return Kl(n)});return zn.join(Bn.tmpdir(),ql,...e)};var Kn=async t=>{try{let e=await J.stat(t);return await J.access(t,J.constants.R_OK|J.constants.W_OK|J.constants.X_OK),e.isDirectory()}catch{return!1}};import{Octokit as Yl}from"@octokit/rest";import Qn from"git-url-parse";var Un;function qn(t){Un=t}function Ie(){return Un}import{CleanOptions as Jn,simpleGit as xt}from"simple-git";import{invariant as Oe}from"ts-invariant";var ke=async t=>(await xt().listRemote(["--symref",t,"HEAD"])).match(/refs\/heads\/(\S+)/m)?.[1],sr=async(t,e)=>(await xt().listRemote([t,e])).split("	")[0],Jl=async({cwd:t,hash:e,branch:r})=>{await xt(t).revparse("HEAD")!==e&&await xt(t).pull("origin",r)},Yn=async(t,{branch:e,upstream:r,fork:o})=>{let n=G.getStore();Oe(n,"No cwd found");let s=xt(n.cwd),i=await ke(r);Oe(i,`No remote default branch found in ${r}`);let a=await Promise.all([sr(r,i),sr(o,i)]);if(a[0]!==a[1]){let p=W("Syncing forked repository");try{(await s.getRemotes()).some(f=>f.name==="upstream")||await s.addRemote("upstream",r),await s.fetch("upstream",i),await s.checkout(e||i),await s.mergeFromTo(`upstream/${i}`,e||i),await s.push("origin",e||i),p.success()}catch(f){p.fail(f.toString())}}},Vn=async(t,{repositoryUrl:e,extraName:r,shallow:o,branch:n,tmpDir:s})=>{if(await Kn(s)){let a=xt(s);console.log(`Directory ${s} already exists, skipping clone`),await a.clean(Jn.FORCE+Jn.RECURSIVE),await a.reset(["--hard"]);let p=await ke(e);Oe(p,`No remote default branch found in ${e}`),await a.checkout(p);let f=p&&await sr(e,p);Oe(f,`No remote default branch hash found in remote ${e}`),await Jl({cwd:s,hash:f,branch:p});let l=(await a.branchLocal()).all.filter(u=>u!==p);l.length&&await a.deleteLocalBranches(l,!0);return}let i=W(`Cloning repository: ${e} to ${s}`);await xt().clone(e,s,o?["--depth","1","--single-branch",...n?[`--branch=${n}`]:[]]:[]),i.success()};function Vl({title:t,body:e,draft:r}){return new c("pr").arguments(()=>({title:t,body:e})).helpers(Ql).executor(async(o,n)=>{let{body:s,title:i}=n.getArguments(),a=Ie();if(!await a?.ensureGithubScopes(["repo"])){console.log("Github scopes not available");return}let f=await a?.getGithubAPIKey(),l=zt();if(f){let u=new Yl({auth:f}),d=Qn(l.get("repository")),h=d.owner,g=d.name,y=(await l.simpleGit.branchLocal()).current,C=X.getStore();if(C?.forkedFrom){let P=Qn(C?.forkedFrom);h=P.owner,g=P.name,y=`${d.owner}:${y}`}let H={owner:h,repo:g,title:i,head:y,base:await ke(l.get("repository")),body:s,draft:r},w=W(`Creating PR for ${h}/${g}`);try{let P=await u.pulls.create(H);w.success(`Created PR ${P.data.html_url}`)}catch(P){if(P.toString().includes("A pull request already exists")){let E=await u.pulls.list({owner:h,repo:g,head:y});if(E.data.length>0){let R=E.data[0];try{await u.pulls.update({owner:h,repo:g,pull_number:R.number,title:i,body:s}),w.success(`Updated PR ${R.html_url}`)}catch(j){w.fail(j.toString())}}else w.fail(P.toString())}else w.fail(P.toString())}await o()}}).return(o=>o.wrappedHelpers()).run()}var Dt=m("pr",Vl),Ql={};var ir=t=>typeof t=="string"?{repository:t,shallow:!0}:t;function Xl(t,e){let r=D(Vn),o=D(Yn);return new c("clone").arguments(()=>{let n=[],s=e;return typeof t=="string"||Array.isArray(t)&&t.every(i=>typeof i=="string")?n=K(t).map(ir):Array.isArray(t)?n=t.map(ir):typeof t=="function"?(n=[],s=t):t&&(n=[ir(t)]),{repositories:n,callback:s}}).helpers(Xn).executor(async(n,s)=>{let{repositories:i}=s.getArguments(),a=X.getStore();i.length===0&&a&&i.push({...a,shallow:!0}),await Promise.all(i.map(({repository:p,shallow:f,branch:l},u)=>G.run({cwd:process.cwd()},async()=>{let d=`${p}, ${String(u)}, ${String(f)}, ${String(l)}`,h=Wn(`${p}${String(u)}`),g=G.getStore(),y=_e.getStore();g&&(g.cwd=h),y&&(y.cwd=h),await r(d,{repositoryUrl:p,branch:l,shallow:f,extraName:String(u),tmpDir:h}),a?.forkedFrom&&await o("",{branch:l,upstream:a.forkedFrom,fork:p}),await we.run(new wt({repository:p,id:d}),n)})))}).callback(async n=>{let{callback:s}=n.getArguments();await s?.(Xn)}).return(n=>n.wrappedHelpers()).run()}var je=m("clone",Xl),Xn={jsFiles:ut,branch:Le,commit:jt,push:ct,dirs:ht,codemod:q,exec:U,files:$,pr:Dt};var Zn={clone:je,branch:Le,push:ct,commit:jt};import Zl from"inquirer";function tu(...t){let e;return new c("question").arguments(()=>({questions:t[0],answers:t[1]})).executor(async(r,o)=>{let{questions:n,answers:s}=o.getArguments();e=await Zl.prompt(n,s),await r?.()}).return(()=>e).run()}var ts=m("question",tu);import{Octokit as ru}from"@octokit/rest";import eu from"git-url-parse";var ar=t=>{let e=eu(t);return{owner:e.owner,repo:e.name,name:e.name}};var ou=async(t,{githubAPIKey:e,parameters:r})=>{let o=new ru({auth:e}),n=W(`Forking ${r.owner}/${r.repo}`);try{let s=await o.repos.createFork(r);n.success(`Forked to ${s.data.full_name}`);let i=s.data.ssh_url,a=s.data.parent?.default_branch??"main";return{repository:i,branch:a}}catch(s){n.fail(s.toString())}};function nu(t,e){let r=D(ou);return new c("fork").arguments(()=>{let o;return typeof t=="string"||Array.isArray(t)&&t.every(n=>typeof n=="string")?o=K(t).map(ar):Array.isArray(t)?o=t.map(n=>typeof n=="string"?ar(n):n):o=[t],{forkParameters:o,callback:e}}).helpers(es).executor(async(o,n)=>{let{forkParameters:s}=n.getArguments(),i=Ie();if(!await i?.ensureGithubScopes(["repo"])){console.log("Github scopes not available");return}let p=await i?.getGithubAPIKey();if(p)for(let f of s){let l=`${f.owner}/${f.repo}`,u=await r(l,{githubAPIKey:p,parameters:f});if(!u)return;await X.run({...u,forkedFrom:`https://github.com/${f.owner}/${f.repo}`},()=>o())}}).callback(async o=>{let{callback:n}=o.getArguments();await n?.(es)}).return(o=>o.wrappedHelpers()).run()}var rs=m("fork",nu),es={clone:je,pr:Dt};var os={fork:rs,pr:Dt};async function su(t){let e=$(t);return await e.astGrep`module.exports={workflow}`.exists()||await e.astGrep`rule:
  pattern:
    context: "{ workflow: () => $_ }"
`.exists()||await e.astGrep`rule:
  pattern:
    context: "export async function workflow($$$_) { $$$_ }"
`.exists()}var WA={git:Zn,astGrep:k,jsFiles:ut,contexts:Ze,dirs:ht,codemod:q,getTree:nn,files:$,exec:U,question:ts,github:os,setAuthService:qn};export{al as SgNode,WA as api,k as astGrep,be as astGrepNodeContext,q as codemod,Ze as contexts,G as cwdContext,tn as describeContext,ht as dirs,U as exec,pt as fileContext,$ as files,L as getAstGrepNodeContext,If as getContextsSnapshot,v as getCwdContext,kf as getDescribeContext,b as getFileContext,zt as getGitContext,Ef as getParentContext,Qe as getParentCwdContext,Of as getRepositoriesContext,Xe as getRepositoryContext,nn as getTree,Zn as git,we as gitContext,os as github,su as isWorkflowEngineFile,ut as jsFiles,Lf as migrateContext,Zo as parentContextLegacy,_e as parentCwdContext,ts as question,Q as registerContext,en as repositoriesContext,X as repositoryContext,qn as setAuthService};
